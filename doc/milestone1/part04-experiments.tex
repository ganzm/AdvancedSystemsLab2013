\documentclass[milestone1.tex]{subfiles} 
\begin{document}

%% ----------------------------------------------
% Section Experiments
%% ----------------------------------------------
\section{Experiments}

\subsection{Testload}
To generate test load for the messaging system a mixture of different types of clients will be chosen. This section describes these clients.

\subsubsection{OneWayClient}
As stated in the project description each OneWayClient sends an initial message to an arbitrary other one. Having it's initial message sent they periodically check their personal queue for incoming messages. If there is one the message is dequeued and forwarded to a random receipient.

Sent messages contain a simple counter which is increased each time a message is relayed.

\subsubsection{PairedClient}
PairedClient's always come in pairs. They keep on sending requests and responses to each other. At start it is determined which client is the requesting client and which is the responding client.

\subsubsection{PublicQueueProducer}
This kind of client writes the same message again and again to a public queue.

\subsubsection{PublicQueueConsumer}
This kind of client tries to read messages at a constant rate from a public queue.

\subsection{2 Hour Test}


% for each experiment
%- why are we doing this experiment
%- hypothesis
%- experiment setup (parameters)
%- plots of the result
%- describe the plot
%- explain the plot/experiment

To verify that the system runs stable over a long period of time an experiment is performed which puts a constant load onto the system for 2 hours.

\paragraph{Experiment setup}
The experiment is performed on the Amazone cloud with a certain number of clients constantly sending messages and some consuming messages. 

\begin{tabular}{|l|c|}
\hline 
Parameter & Value \\
\hline 
Amazone instance type for the database & TODO \\ 
Amazone instance type for the middle(s) ware& TODO \\ 
Amazone instance type for the clients & TODO \\ 
Number of middle wares & 1 \\ 
Number of sending clients & 4 (2 per machine) \\ 
Number of sending clients & 4 (2 per machine) \\ 
Client message send interval & 100ms \\
\hline 
\end{tabular}

\paragraph{Hypothesis}
Since the system will not be saturated we expect no changes over time concerning response time and throughput. The mixture of clients generating load is chosen such that there is a constant number of messages in the system. Increased SQL query execution time should not be observable.

\paragraph{Results}

TODO

See Testrun 11

% https://testmaster-asl-eth.renuo.ch/test_runs/11

\paragraph{Interpretation}

TODO

%% -------------------------------------------
%% 2^k Experiment
%% -------------------------------------------
\subsection{$2^k$ Experiment}
In order to determine the influence of a number of primary factors on to the system it was decided to do a $2^k$ analysis on several factors described in the following section.

For each feature level an experiment of 30 minutes is performed where clients perform 100 actions (send and receive message) per second.

\subsubsection{Factors and Levels}

\paragraph{Number of Clients}
The number of simultaneously connected clients is varied between 8 and 30. There is a mix of different clients which produce slightly different types of load.

\begin{tabular}{|l|c|c|}
\hline 
 & Lower Level & Upper Level \\ 
\hline 
OneWayClient & 16 & 8  \\ 
\hline 
PairedClient & 8 & 4 \\ 
\hline 
PublicQueueConsumer & 4 & 2 \\ 
\hline 
PublicQueueProducer & 2 & 1 \\ 
\hline 
\textbf{Total}  & \textbf{30} & \textbf{15} \\
\hline 
\end{tabular} 

\paragraph{Number of brokers}

The number of middleware components is varied between 4 and 8. For both levels the number of Amazone instances used is 2.

\paragraph{Number of workers}

The number of worker threads a single middle ware instance has is varied between 4 and 8

\paragraph{Number of Database Connections}

The number of concurrent database connection a single middle ware instance has is varied between 4 and 8

\subsubsection{Hypothesis}

The response time should not be majorly affected by these chosen parameters. Since the system is not under much load only small changes concerning the response time should be observable.

However the number of requests processes should vary. The main feature which obviously affects number of requests is the number of connected clients sending messages. Other minor variations will reveal bottle necks in the system.

\subsubsection{Measurement Results}
The following table shows median time taken and number of requests processed for all different feature levels.\\

\begin{figure}[H]
	\begin{center}
	
\begin{tabular}{cccccccc}
\rot{Clients} & 
\rot{Brokers} & 
\rot{Workers} & 
\rot{Connections} & 
\rot{TestRun Id} & 
\rot{Median Processing time [ms]} & 
\rot{\# of Processed Requests} \\
\hline 
15 & 4 & 4 & 4 & 2003 & \numprint{6.80} & \numprint{1996478} \\ 
\hline 
15 & 4 & 4 & 8 & 173 & \numprint{7.46} & \numprint{1806665} \\ 
\hline 
15 & 4 & 8 & 4 & 2007 & \numprint{6.87} & \numprint{2062704} \\ 
\hline 
15 & 4 & 8 & 8 & 2008 & \numprint{7.21}  & \numprint{2060655} \\ 
\hline 
15 & 8 & 4 & 4 & 2009 & \numprint{5.11} & \numprint{1385552} \\ 
\hline 
15 & 8 & 4 & 8 & 2004 & \numprint{7.55} & \numprint{1910840} \\ 
\hline 
15 & 8 & 8 & 4 & 2005 & \numprint{5.90} & \numprint{1975889} \\ 
\hline 
15 & 8 & 8 & 8 & 2006 & \numprint{7.60} & \numprint{1920835} \\ 
\hline 
30 & 4 & 4 & 4 & 159 & \numprint{14.08} & \numprint{2488948} \\ 
\hline 
30 & 4 & 4 & 8 & 160 & \numprint{12.80} & \numprint{2451248} \\ 
\hline 
30 & 4 & 8 & 4 & 161 & \numprint{13.42} & \numprint{2428769} \\ 
\hline 
30 & 4 & 8 & 8 & 162 & \numprint{13.97} & \numprint{2511260}  \\ 
\hline 
30 & 8 & 4 & 4 & 163 & \numprint{12.43} & \numprint{2329883} \\ 
\hline 
30 & 8 & 4 & 8 & 164 & \numprint{14.85} & \numprint{2110459} \\ 
\hline 
30 & 8 & 8 & 4 & 165 & \numprint{12.88} & \numprint{2266237} \\ 
\hline 
30 & 8 & 8 & 8 & 166 & \numprint{15.05} & \numprint{2166303}  \\ 
\hline 

\end{tabular} 
\end{center}
\caption{$2^4$ factorial test measurements}
\label{fig:2kfactorialmeasurement}
\end{figure}

\paragraph{Signs} As $2^k$ factorial test states we now assign $+$ and $-$ to our levels:
\begin{itemize}
\item Number of Client \textbf{c} is $+$ if 30, $-$ if 15
\item Number of Brokers \textbf{b} is $+$ if 8, $-$ if 4
\item Number of Workers \textbf{w} is $+$ if 8, $-$ if 4
\item Number of Db Connections \textbf{d} is $+$ if 8, $-$ if 4
\end{itemize}

We then obtain the following sign table. With which we then calculate the weights for the $4$ factors.

\begin{figure}[H]
	\begin{center}
\begin{tabular}{ccccccccccccccccc}
\hline 
 & I &	c&	b&	w&	d&	cb&	cw&	cd&	bw&	bd&	wd&	bwd&	cwd&	cbd&	cbw&	cbwd \\
\hline 
&1&	-1&	-1&	-1&	-1&	1&	1&	1&	1&	1&	1&	-1&	-1&	-1&	-1&	1 \\
&1&	-1&	-1&	-1&	1&	1&	1&	-1&	1&	-1&	-1&	1&	1&	1&	-1&	-1 \\
&1&	-1&	-1&	1&	-1&	1&	-1&	1&	-1&	1&	-1&	1&	1&	-1&	1&	-1 \\
&1&	-1&	-1&	1&	1&	1&	-1&	-1&	-1&	-1&	1&	-1&	-1&	1&	1&	1 \\
&1&	-1&	1&	-1&	-1&	-1&	1&	1&	-1&	-1&	1&	1&	-1&	1&	1&	-1 \\
&1&	-1&	1&	-1&	1&	-1&	1&	-1&	-1&	1&	-1&	-1&	1&	-1&	1&	1 \\
&1&	-1&	1&	1&	-1&	-1&	-1&	1&	1&	-1&	-1&	-1&	1&	1&	-1&	1 \\
&1&	-1&	1&	1&	1&	-1&	-1&	-1&	1&	1&	1&	1&	-1&	-1&	-1&	-1 \\
&1&	1&	-1&	-1&	-1&	-1&	-1&	-1&	1&	1&	1&	-1&	1&	1&	1&	-1 \\
&1&	1&	-1&	-1&	1&	-1&	-1&	1&	1&	-1&	-1&	1&	-1&	-1&	1&	1 \\
&1&	1&	-1&	1&	-1&	-1&	1&	-1&	-1&	1&	-1&	1&	-1&	1&	-1&	1 \\
&1&	1&	-1&	1&	1&	-1&	1&	1&	-1&	-1&	1&	-1&	1&	-1&	-1&	-1 \\
&1&	1&	1&	-1&	-1&	1&	-1&	-1&	-1&	-1&	1&	1&	1&	-1&	-1&	1 \\
&1&	1&	1&	-1&	1&	1&	-1&	1&	-1&	1&	-1&	-1&	-1&	1&	-1&	-1 \\
&1&	1&	1&	1&	-1&	1&	1&	-1&	1&	-1&	-1&	-1&	-1&	-1&	1&	-1 \\
&1&	1&	1&	1&	1&	1&	1&	1&	1&	1&	1&	1&	1&	1&	1&	1 \\

\hline 

\rot[90]{\textbf{Weights~}} & 
\rot[90]{\textbf{10.24}} &	
\rot[90]{\textbf{3.43}} &	
\rot[90]{-0.07} &	
\rot[90]{0.11} &	
\rot[90]{\textbf{0.56}} &	
\rot[90]{0.19} &	
\rot[90]{0.03} &	
\rot[90]{-0.08} &	
\rot[90]{0.07} &	
\rot[90]{\textbf{0.52}} &	
\rot[90]{0.03} &	
\rot[90]{-0.15} &	
\rot[90]{0.16} &	
\rot[90]{0.13} &	
\rot[90]{-0.05} &	
\rot[90]{-0.10} \\
\hline 
\end{tabular}

\end{center}
\caption{$2^4$ factorial test result}
\label{fig:2kfactorialresults}
\end{figure}

\subsubsection{Interpretation}
Mean performance concerning response time has a value of $10.24$. The effect of varying number of clients from 15 to 30 has a weight of $3.43$. This means when increasing the number of clients (and number of requests) the response time also increases. The other values are relatively low. Number of database connections $d$ and number of brokers $b$ in combination with number of database connections  are the next values worth to have a look at. This means that the number of database connections has the most significant impact on response time. By varying number of brokers the total number of database connections also change.

Overall the most significant factor which affects performance the most (beside the load applied by clients) is the number of database connections. This indicates that the database is a bottle neck.

%% -------------------------------------------
\subsection{Db Load Test}

testrun 87 shows what happens when we add more messages than we delete. 

After 2h the database contains 170000 messages
show plots for query peek time, etc
db access gets slower

\subsection{divers}

testrun 105 - out of disk space

\end{document}